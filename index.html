<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <title>Gerador de Relatórios – Manutenção Inteligente</title>
</head>
<body class="bg-light">

    <div class="container my-5">
        <div class="text-center mb-4">
            <h1 class="display-6">Gerador de Relatórios – Manutenção Inteligente</h1>
            <p class="lead">
                “Automatize, padronize e simplifique suas rotinas de manutenção.”
            </p>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-4 p-md-5">
                
                <form id="relatorio-form"> 
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="tipo_manutencao" class="form-label fw-bold">Tipo de Manutenção:</label>
                            <select id="tipo_manutencao" name="tipo_manutencao" class="form-select auto-save" required>
                                <option value="PREVENTIVA" selected>Preventiva</option>
                                <option value="CORRETIVA">Corretiva</option>
                                <option value="INSPEÇÃO">Inspeção</option>
                                <option value="MELHORIA">Melhoria</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="data_manutencao" class="form-label fw-bold">Data da Manutenção:</label>
                            <input type="date" id="data_manutencao" name="data_manutencao" class="form-control auto-save" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="executantes" class="form-label fw-bold">Executantes:</label>
                        <textarea id="executantes" name="executantes" class="form-control auto-save" rows="3" placeholder="Ex: João Silva, Maria Souza (um por linha ou separados por vírgula)"></textarea>
                    </div>

                    <hr class="my-4">
                    
                    <h3 class="mb-3">Equipamentos</h3>
                    <div id="equipamentos-container" class="mb-3">
                        </div>
                    
                    <button type="button" class="btn btn-success" onclick="addEquipamento()">
                        <i class="bi bi-plus-circle"></i> Adicionar Equipamento
                    </button>
                    
                    <hr class="my-4">
                    
                    <div class="mb-3">
                        <label for="justificativa_obs" class="form-label fw-bold">Observações Gerais:</label>
                        <textarea id="justificativa_obs" name="justificativa_obs" class="form-control auto-save" rows="3" placeholder="Descreva qualquer observação geral, justificativa ou problema encontrado..."></textarea>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-4">
                        <button type="button" class="btn btn-primary btn-lg" onclick="gerarRelatorio()">
                            <i class="bi bi-clipboard2-check"></i> Gerar Relatório
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="copiarRelatorio()">
                            <i class="bi bi-copy"></i> Copiar Relatório
                        </button>
                        <button type="button" class="btn btn-warning text-dark" onclick="baixarPDF()">
                            <i class="bi bi-file-earmark-pdf"></i> Baixar em PDF
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="limparCampos()">
                            <i class="bi bi-arrow-counterclockwise"></i> Limpar Campos
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm mt-5">
            <div class="card-header">
                <h4 class="mb-0">Relatório Gerado (Pronto para Copiar):</h4>
            </div>
            <div class="card-body">
                <pre id="relatorio-final" class="bg-dark text-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word;">O seu relatório aparecerá aqui...</pre>
            </div>
        </div>
    </div>

    <datalist id="lista-equipamentos">
        <option value="PF1105">
        <option value="PF1111">
        <option value="PF6753">
    </datalist>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        let uniqueEquipId = 0;
        const STORAGE_KEY = 'dadosRelatorioManutencao';

        const TEMPLATES = {
            'PREVENTIVA': {
                atividades: "",
                pendencias: ""
            },
            'CORRETIVA': {
                atividades: "Análise da falha:\n- (Descrever a causa)\n\nPeça(s) substituída(s):\n- (Listar peças)\n\nTestes realizados após intervenção.",
                pendencias: "Nenhuma pendência adicional."
            },
            'INSPEÇÃO': {
                atividades: "Inspeção realizada nos seguintes pontos:\n- Mecânicos\n- Elétricos\n- Segurança\n- Operacionais",
                pendencias: "Pontos de atenção para próxima preventiva:\n-"
            },
            'MELHORIA': {
                atividades: "Implementação da melhoria:\n- (Descrever a melhoria)\n\nObjetivo:\n- (Descrever o objetivo)",
                pendencias: "Monitorar performance após implementação."
            },
            'DEFAULT': { atividades: "", pendencias: "" }
        };

        // --- Funções de Inicialização e Persistência (sem alteração) ---

        document.addEventListener("DOMContentLoaded", function() {
            carregarEstadoFormulario();
            document.querySelectorAll('.auto-save').forEach(element => {
                element.addEventListener('input', salvarEstadoFormulario);
            });
        });

        function setDefaultDate() {
            const dateInput = document.getElementById('data_manutencao');
            if (!dateInput.value) {
                const today = new Date().toISOString().split('T')[0]; 
                dateInput.value = today;
            }
        }

        function salvarEstadoFormulario() {
            const dados = {
                camposEstaticos: {},
                equipamentos: [],
                uniqueEquipId: uniqueEquipId
            };
            document.querySelectorAll('.auto-save').forEach(element => {
                dados.camposEstaticos[element.id] = element.value;
            });
            document.querySelectorAll('#equipamentos-container .equip-bloco').forEach(bloco => {
                const id = bloco.id.split('-')[1];
                const equipamento = {
                    id: id,
                    nome: document.getElementById(`equip_nome_${id}`).value,
                    realizado: document.getElementById(`equip_realizado_${id}`).value,
                    atividades: document.getElementById(`atividades_${id}`).value,
                    pendencias: document.getElementById(`pendencias_${id}`).value
                };
                dados.equipamentos.push(equipamento);
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dados));
        }

        function carregarEstadoFormulario() {
            const dadosSalvos = localStorage.getItem(STORAGE_KEY);
            if (!dadosSalvos) {
                setDefaultDate(); 
                return;
            }
            const dados = JSON.parse(dadosSalvos);
            if (dados.camposEstaticos) {
                Object.keys(dados.camposEstaticos).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = dados.camposEstaticos[key];
                    }
                });
            }
            uniqueEquipId = dados.uniqueEquipId || 0;
            if (dados.equipamentos) {
                dados.equipamentos.forEach(equipData => {
                    addEquipamento(equipData);
                });
            }
            setDefaultDate(); 
        }

        // --- Funções de Equipamento (sem alteração) ---

        function addEquipamento(dados = null) {
            let currentId;
            let isNew = false;
            
            if (dados) {
                currentId = dados.id;
            } else {
                uniqueEquipId++;
                currentId = uniqueEquipId;
                isNew = true;
            }

            const container = document.getElementById('equipamentos-container');
            const newEquip = document.createElement('div');
            newEquip.className = 'card equip-bloco mb-3';
            newEquip.id = `equipamento-${currentId}`; 
            
            newEquip.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Equipamento #${currentId}</h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeEquipamento(${currentId})">
                            <i class="bi bi-trash"></i> Remover
                        </button>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="equip_nome_${currentId}" class="form-label">Nome do Equipamento:</label>
                            <input type="text" id="equip_nome_${currentId}" name="equip_nome_${currentId}" class="form-control" placeholder="Ex: PF1146 (digite ou selecione)" list="lista-equipamentos">
                        </div>
                        <div class="col-md-4">
                            <label for="equip_realizado_${currentId}" class="form-label">Realizado (%):</label>
                            <input type="text" id="equip_realizado_${currentId}" name="equip_realizado_${currentId}" class="form-control" placeholder="Ex: 100%">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="atividades_${currentId}" class="form-label">Atividades Realizadas:</label>
                        <textarea id="atividades_${currentId}" name="atividades_${currentId}" class="form-control" rows="4" placeholder="Descreva as atividades executadas..."></textarea>
                    </div>
                    <div class="mt-3">
                        <label for="pendencias_${currentId}" class="form-label">Pendências:</label>
                        <textarea id="pendencias_${currentId}" name="pendencias_${currentId}" class="form-control" rows="2" placeholder="Descreva as pendências..."></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newEquip);

            const atividadesInput = document.getElementById(`atividades_${currentId}`);
            const pendenciasInput = document.getElementById(`pendencias_${currentId}`);

            if (isNew) {
                const tipoManutencao = document.getElementById('tipo_manutencao').value;
                const template = TEMPLATES[tipoManutencao] || TEMPLATES['DEFAULT'];
                atividadesInput.value = template.atividades;
                pendenciasInput.value = template.pendencias;
            } else if (dados) {
                document.getElementById(`equip_nome_${currentId}`).value = dados.nome;
                document.getElementById(`equip_realizado_${currentId}`).value = dados.realizado;
                atividadesInput.value = dados.atividades;
                pendenciasInput.value = dados.pendencias;
            }

            document.querySelectorAll(`#equipamento-${currentId} input, #equipamento-${currentId} textarea`).forEach(el => {
                el.addEventListener('input', salvarEstadoFormulario);
            });

            if (isNew) {
                salvarEstadoFormulario();
            }
        }
        
        function removeEquipamento(id) {
            const equipBloco = document.getElementById(`equipamento-${id}`);
            if (equipBloco) {
                equipBloco.remove();
                salvarEstadoFormulario();
            }
        }

        // --- Funções de Ação (Gerar, Copiar, Limpar) ---

        function limparCampos() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('relatorio-form').reset();
            document.getElementById('equipamentos-container').innerHTML = '';
            document.getElementById('relatorio-final').textContent = 'O seu relatório aparecerá aqui...';
            uniqueEquipId = 0;
            setDefaultDate();
        }

        function copiarRelatorio() {
            const relatorioTexto = document.getElementById('relatorio-final').textContent;
            if (relatorioTexto.trim() === 'O seu relatório aparecerá aqui...' || relatorioTexto.trim() === '') {
                alert('Gere um relatório antes de tentar copiar!');
                return;
            }
            navigator.clipboard.writeText(relatorioTexto)
                .then(() => {
                    alert('Relatório copiado para a área de transferência!');
                })
                .catch(err => {
                    alert('Falha ao copiar. Tente manualmente.');
                });
        }

        // 1.5: Nova função para Baixar PDF
        function baixarPDF() {
            const relatorioTexto = document.getElementById('relatorio-final').textContent;
            
            // 1. Valida se o relatório existe
            if (relatorioTexto.trim() === 'O seu relatório aparecerá aqui...' || relatorioTexto.trim() === '') {
                alert('Gere um relatório antes de tentar baixar o PDF!');
                return;
            }

            // 2. Pega dados para o nome do arquivo
            const data = document.getElementById('data_manutencao').value || 'data';
            const tipo = document.getElementById('tipo_manutencao').value;
            const filename = `Relatorio_${tipo}_${data}.pdf`;

            try {
                // 3. Inicializa o jsPDF
                // Precisamos extrair o construtor do objeto global window.jspdf
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // 4. Define a fonte para Courier (monoespaçada) para bater com o <pre>
                doc.setFont('Courier', 'normal');
                doc.setFontSize(10); // Tamanho bom para leitura

                // 5. Define margens e largura máxima do texto
                const margin = 15; // 15mm de margem
                const pageWidth = doc.internal.pageSize.getWidth();
                const maxWidth = pageWidth - (margin * 2); // Largura máxima do texto

                // 6. Adiciona o texto ao PDF
                // O método .text() com 'maxWidth' cuida automaticamente de
                // quebras de linha e até de criar novas páginas (auto-paginação).
                doc.text(relatorioTexto, margin, margin, {
                    maxWidth: maxWidth
                });

                // 7. Salva o arquivo
                doc.save(filename);

            } catch (error) {
                alert('Ocorreu um erro ao gerar o PDF.');
                console.error("Erro no jsPDF: ", error);
            }
        }


        function gerarRelatorio() {
            // (Função sem alteração)
            salvarEstadoFormulario();
            const tipoManutencao = document.getElementById('tipo_manutencao').value; 
            const data = document.getElementById('data_manutencao').value;
            const executantes = document.getElementById('executantes').value;
            const justificativaObs = document.getElementById('justificativa_obs').value;

            let dataFormatada = data;
            if (data && data.includes('-')) {
                 const partes = data.split('-');
                 dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
            }

            let atividadesTexto = "";
            let pendenciasTexto = "";
            
            const equipamentos = document.querySelectorAll('#equipamentos-container .equip-bloco');

            equipamentos.forEach(bloco => {
                const id = bloco.id.split('-')[1]; 
                const nomeInput = document.getElementById(`equip_nome_${id}`);
                const realizadoInput = document.getElementById(`equip_realizado_${id}`);
                const atividadesInput = document.getElementById(`atividades_${id}`);
                const pendenciasInput = document.getElementById(`pendencias_${id}`);

                const nome = nomeInput ? nomeInput.value.trim() : '';
                const realizadoPerc = realizadoInput ? realizadoInput.value.replace('%', '').trim() : '';
                const atividade = atividadesInput ? atividadesInput.value.trim() : '';
                const pendencia = pendenciasInput ? pendenciasInput.value.trim() : '';

                if (nome) {
                    const nomeUpper = nome.toUpperCase(); 
                    const realizadoFinal = realizadoPerc ? (realizadoPerc.endsWith('%') ? realizadoPerc : `${realizadoPerc}%`) : 'N/A';
                    
                    if (atividade) {
                        atividadesTexto += `${nomeUpper} (Realizado: ${realizadoFinal}):\n${atividade}\n\n`;
                    }
                    if (pendencia) {
                        pendenciasTexto += `${nomeUpper}:\n${pendencia}\n\n`;
                    }
                }
            });

            const atividadesFinais = atividadesTexto.trim() || "Nenhuma atividade registrada.";
            const pendenciasFinais = pendenciasTexto.trim() || "Nenhuma pendência registrada.";
            const executantesFinais = executantes.trim() || "Nenhum executante listado.";
            const obsFinais = justificativaObs.trim() || "Nenhuma observação geral.";

            const relatorioFinal = `
MANUTENÇÃO ${tipoManutencao} - ${dataFormatada}

Executantes:
${executantesFinais}
------------------------------------
Atividades realizadas:
${atividadesFinais}

------------------------------------
Pendências:
${pendenciasFinais}
-----------------------------------------
OBSERVAÇÕES GERAIS:
${obsFinais}
-----------------------------------------
`;
            
            document.getElementById('relatorio-final').textContent = relatorioFinal.trim();
        }
    </script>
</body>
</html>
