from flask import Flask, request, render_template_string

# Configuração inicial do Flask
app = Flask(__name__)

# O HTML do nosso formulário e da página de resultados.
# AGORA com % por equipamento e sem a seção de Acompanhamento do Plano.
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relatório</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h2, h3, h4 { color: #333; }
        form { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea {
            width: 95%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-family: Arial, sans-serif;
        }
        /* Ajuste para inputs dentro de grids não estourarem */
        .equip-grid-2-col input[type="text"] {
             width: 90%; /* Ajuste fino */
        }
        
        textarea { height: 100px; }
        
        /* Estilos dos botões */
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #0056b3; }
        
        button.add-equip {
            background-color: #28a745; /* Verde */
            font-size: 14px;
            padding: 8px 12px;
            margin-top: 10px;
        }
        button.add-equip:hover { background-color: #218838; }

        /* Estilo do relatório final */
        pre {
            background-color: #eee;
            border: 1px dashed #ccc;
            padding: 15px;
            white-space: pre-wrap; /* Garante a quebra de linha */
            word-wrap: break-word; /* Garante que palavras longas não estourem */
            font-family: monospace;
            font-size: 14px;
        }
        
        /* Div para cada equipamento adicionado */
        .equip-bloco {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            background: #fdfdfd;
        }

        /* --- NOVO ESTILO (Grid p/ Equipamento) --- */
        .equip-grid-2-col {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2/3 para nome, 1/3 para % */
            gap: 15px;
        }
        .equip-grid-2-col div {
            margin-bottom: 0;
        }
        /* --- FIM NOVO ESTILO --- */


    </style>
</head>
<body>

    <h2>Gerador de Relatório de Manutenção</h2>
    <p>Preencha os campos abaixo para gerar o relatório padronizado.</p>

    <form method="POST">
        <div>
            <label for="data_manutencao">Data da Manutenção (ex: 17/10/25):</label>
            <input type="text" id="data_manutencao" name="data_manutencao">
        </div>
        <div>
            <label for="executantes">Executantes (um por linha):</label>
            <textarea id="executantes" name="executantes" rows="3"></textarea>
        </div>

        <hr>
        <h3>Equipamentos</h3>
        
        <div id="equipamentos-container">
            <!-- Blocos de equipamento entram aqui via JS -->
        </div>
        
        <input type="hidden" name="equip_count" id="equip_count" value="0">
        
        <button type="button" class="add-equip" onclick="addEquipamento()">
            + Adicionar Equipamento
        </button>
        
        <hr>
        
        <!-- === SEÇÃO DE ACOMPANHAMENTO REMOVIDA === -->
        
        <div>
            <label for="justificativa_obs">Observações Gerais:</label>
            <textarea id="justificativa_obs" name="justificativa_obs"></textarea>
        </div>

        <button type="submit">Gerar Relatório</button>
    </form>

    <h3>Relatório Gerado (Pronto para Copiar):</h3>
    <pre>{{ relatorio_gerado }}</pre>


    <script>
        let equipCount = 0;

        function addEquipamento() {
            equipCount++;
            document.getElementById('equip_count').value = equipCount;
            const container = document.getElementById('equipamentos-container');
            const newEquip = document.createElement('div');
            newEquip.className = 'equip-bloco'; 
            
            // --- MUDANÇA AQUI: Adicionado grid e campo de % ---
            newEquip.innerHTML = `
                <h4>Equipamento #${equipCount}</h4>
                
                <div class="equip-grid-2-col">
                    <div>
                        <label for="equip_nome_${equipCount}">Nome do Equipamento:</label>
                        <input type="text" id="equip_nome_${equipCount}" name="equip_nome_${equipCount}" placeholder="Ex: PF1146">
                    </div>
                    <div>
                        <label for="equip_realizado_${equipCount}">Realizado (%):</label>
                        <input type="text" id="equip_realizado_${equipCount}" name="equip_realizado_${equipCount}" value="100%">
                    </div>
                </div>

                <div>
                    <label for="atividades_${equipCount}">Atividades Realizadas:</label>
                    <textarea id="atividades_${equipCount}" name="atividades_${equipCount}"></textarea>
                </div>
                <div>
                    <label for="pendencias_${equipCount}">Pendências:</label>
                    <textarea id="pendencias_${equipCount}" name="pendencias_${equipCount}"></textarea>
                </div>
                <datalist id="lista-equipamentos">
                    <option value="PF1105">
                    <option value="PF1111">
                    <option value="PF1115">
                    <option value="PF1120">
                    <option value="PF1140">
                    <option value="PF1142">
                    <option value="PF1144">
                    <option value="PF1145"> 
                    <option value="PF1146">
                    <option value="PF1147">
                    <option value="PF1148">
                    <option value="PF6750">   
                    <option value="PF6752"> 
                    <option value="PF6753"> 
                    <!-- Adicione mais códigos aqui se precisar -->
                </datalist>
            </div>
            `;
            // --- FIM DA MUDANÇA ---
            container.appendChild(newEquip);
        }
    </script>
    </body>
</html>
"""

# Esta é a rota principal da nossa aplicação
@app.route('/', methods=['GET', 'POST'])
def home():
    relatorio_final = "" # Começa com o relatório vazio

    if request.method == 'POST':
        # 1. Coletar dados gerais do formulário
        data = request.form.get('data_manutencao')
        executantes = request.form.get('executantes')
        
        # Campos de acompanhamento do plano foram removidos
        justificativa_obs = request.form.get('justificativa_obs')

        # 2. Coletar dados DINÂMICOS dos equipamentos
        atividades_texto = ""
        pendencias_texto = ""
        
        count_str = request.form.get('equip_count', '0')
        count = int(count_str) if count_str.isdigit() else 0

        for i in range(1, count + 1):
            nome = request.form.get(f'equip_nome_{i}')
            # --- NOVO CAMPO COLETADO ---
            realizado_perc = request.form.get(f'equip_realizado_{i}', '100') # Padrão 100 se vazio
            
            atividade = request.form.get(f'atividades_{i}')
            pendencia = request.form.get(f'pendencias_{i}')
            
            if nome and nome.strip():
                nome_upper = nome.strip().upper() 
                
                if atividade and atividade.strip():
                    # Adiciona a % ao lado do nome do equipamento
                    atividades_texto += f"{nome_upper} (Realizado: {realizado_perc}%):\n{atividade}\n\n"
                    
                if pendencia and pendencia.strip():
                    # Pendências não incluem a %
                    pendencias_texto += f"{nome_upper}:\n{pendencia}\n\n"

        # 3. Montar o relatório final com a NOVA formatação
        relatorio_final = f"""
MANUTENÇÃO PREVENTIVA - {data}

Executantes:
{executantes}
------------------------------------
Atividades realizadas:
{atividades_texto.strip()}

------------------------------------
Pendências
{pendencias_texto.strip()}
-----------------------------------------
OBSERVAÇÕES GERAIS
{justificativa_obs}
-----------------------------------------
"""

    # 4. Renderizar a página HTML, passando o relatório gerado (ou vazio)
    return render_template_string(HTML_TEMPLATE, relatorio_gerado=relatorio_final)
